#!/usr/bin/env bash

set -a

LIBUV_VERSION=${LIBUV_VERSION:-0.10.28}
LIBZIP_VERSION=${LIBZIP_VERSION:-0.11.2}

export MASON_DIR=".mason"

git submodule update --init

function quote_flags {
    python -c "import sys, re; print filter(None, re.split('(?<!-framework)\s+', ' '.join(sys.argv[1:])))" "$@"
}

CONFIG="# Do not edit. Generated by the configure script.
{
  'target_defaults': {
    'cflags%': [],
    'default_configuration': 'Release',
    'defines': [],
    'include_dirs': [],
    'libraries': []
  },
  'variables': {
"

LN=$'\n'

if [ ! -z ${LIBUV_VERSION} ]; then
    .mason/mason install libuv ${LIBUV_VERSION}
    CONFIG+="    'uv_static_libs%': $(quote_flags $(.mason/mason static_libs libuv ${LIBUV_VERSION})),"$LN
    CONFIG+="    'uv_cflags%': $(quote_flags $(.mason/mason cflags libuv ${LIBUV_VERSION})),"$LN
    CONFIG+="    'uv_ldflags%': $(quote_flags $(.mason/mason ldflags libuv ${LIBUV_VERSION})),"$LN
fi

if [ ! -z ${LIBZIP_VERSION} ]; then
    .mason/mason install libzip ${LIBZIP_VERSION}
    CONFIG+="    'zip_static_libs%': $(quote_flags $(.mason/mason static_libs libzip ${LIBZIP_VERSION})),"$LN
    CONFIG+="    'zip_cflags%': $(quote_flags $(.mason/mason cflags libzip ${LIBZIP_VERSION})),"$LN
    CONFIG+="    'zip_ldflags%': $(quote_flags $(.mason/mason ldflags libzip ${LIBZIP_VERSION})),"$LN
fi

CONFIG+="  }
}
"

echo "${CONFIG}" > 'config.gypi'
cat config.gypi